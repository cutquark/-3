# 寰宇杀桌游数据管理器 - 元素损伤功能技术文档

## 目录
1. [功能概述](#功能概述)
2. [文件结构](#文件结构)
3. [数据模型](#数据模型)
4. [元素类型与效果](#元素类型与效果)
5. [界面实现](#界面实现)
6. [主要功能实现](#主要功能实现)
   - [元素损伤积累与显示](#元素损伤积累与显示)
   - [元素爆条功能](#元素爆条功能)
   - [元素攻击功能](#元素攻击功能)
   - [元素治疗功能](#元素治疗功能)
7. [状态效果实现](#状态效果实现)
8. [重要函数说明](#重要函数说明)
9. [注意事项与扩展](#注意事项与扩展)

## 功能概述

元素损伤功能是寰宇杀桌游数据管理器中的一个重要模块，主要用于模拟游戏中的元素伤害机制。该功能包括：

- 五种元素类型：灼燃、水蚀、神经、凋亡、雷电
- 元素损伤值的跟踪和管理
- 元素爆条（当元素损伤值达到500时触发特殊效果）
- 元素攻击（直接造成元素伤害）
- 元素治疗（减少目标的元素伤害值）
- 元素状态效果（如燃烧、虚弱、眩晕等）

## 文件结构

元素损伤功能的代码主要分布在以下文件中：

- `elements/element.js` - 元素类型定义、接口函数和元素效果实现
- `elements/element.css` - 元素相关的样式定义
- `script.js` - 包含主要功能实现，如元素爆条、元素攻击和治疗等

## 数据模型

每个单位（unit）对象中新增了以下与元素相关的属性：

```javascript
unit.elementDamage = {
    fire: 0,    // 灼燃元素伤害值
    water: 0,   // 水蚀元素伤害值
    neural: 0,  // 神经元素伤害值
    wither: 0,  // 凋亡元素伤害值
    thunder: 0  // 雷电元素伤害值
};
```

## 元素类型与效果

在 `element.js` 中定义了五种元素类型及其效果：

| 元素类型 | 中文名称 | 爆条效果 |
|---------|--------|---------|
| fire    | 灼燃    | 扣除100当前生命值，添加3回合的燃烧效果，每回合-20HP |
| water   | 水蚀    | 扣除100当前生命值，添加3回合的虚弱效果，攻击力-20%，攻击间隔+20% |
| neural  | 神经    | 扣除100当前生命值，添加2回合的眩晕效果 |
| wither  | 凋亡    | 扣除100当前生命值，添加3回合的脆弱效果，防御力-20%，法术抗性-20% |
| thunder | 雷电    | 扣除150当前生命值，不添加特殊效果 |

## 界面实现

### 元素损伤显示

在单位表格中添加了"元素损伤"列，显示每个单位的五种元素损伤值，并在每种元素类型旁提供输入框和"爆条"按钮。

### 攻击界面的元素选项

在攻击模态框中添加了多种与元素相关的选项：
- 元素攻击类型选择
- 附带元素伤害选项
- 元素治疗类型选择
- 附带元素治疗选项

## 主要功能实现

### 元素损伤积累与显示

元素损伤值存储在每个单位的 `elementDamage` 对象中，通过表格中的专门列展示，并可以通过输入框手动修改。

相关代码：
```javascript
// 在renderTable函数中创建元素损伤单元格
let elementDamageCell = row.insertCell();
elementDamageCell.className = 'element-damage-cell';
```

### 元素爆条功能

当某种元素损伤值达到500或以上时，"爆条"按钮变为可点击状态。点击后触发以下效果：
1. 减少500点该类型的元素损伤值
2. 根据元素类型对目标造成直接生命值伤害
3. 根据元素类型添加特定状态效果

实现代码位于 `elementExplosion` 函数中，主要步骤：
- 检查元素损伤值是否足够
- 扣除对应元素损伤值
- 应用相应的HP减少和状态效果

### 元素攻击功能

在攻击模态框中可以选择"元素攻击"，直接对目标造成元素伤害，累积目标的元素损伤值。

### 元素治疗功能

在治疗模态框中可以选择"元素治疗"，减少目标的特定元素伤害值。同时解决了元素治疗找不到目标的问题，现在根据元素伤害值来选择可治疗的目标。

## 状态效果实现

元素爆条产生的状态效果会添加到单位的 `statuses` 数组中，并可能包含以下附加效果：

- **recurring-damage**: 每回合造成固定伤害（如燃烧效果）
- **buff**: 修改单位的属性值（如虚弱、脆弱效果）

## 重要函数说明

### `elementExplosion(type, id, elementType)`
触发元素爆条效果，应用伤害和状态效果。

### `updateTargetList(attackerType, isHealMode)`
更新攻击/治疗目标列表，在元素治疗模式下筛选有对应元素伤害的目标。

### `executeAttack()`
执行攻击/治疗操作，处理元素攻击和元素治疗逻辑。

### `renderElementOptions()`
生成元素相关选项的HTML代码，用于攻击/治疗模态框。

## 注意事项与扩展

1. **新单位初始化**: 确保新创建的单位初始化了 `elementDamage` 对象

2. **深拷贝处理**: 在复制单位时需要对 `elementDamage` 对象进行深拷贝，以避免多个单位共享同一个数据对象

3. **元素效果扩展**: 可以通过修改 `elementTypes` 对象和 `elementExplosion` 函数来添加或修改元素效果

4. **元素攻击限制**: 当前元素值上限无硬性限制，但UI显示会在500时启用爆条按钮

5. **元素治疗目标筛选**：元素治疗现在会正确筛选有对应元素伤害的目标 